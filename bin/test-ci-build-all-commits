#!/usr/bin/env sh

branch=$CIRCLE_BRANCH
dir=$(dirname $0)
cmd="npm run compile && npm test"

echo "reseting master so $branch is branched properly."
git branch -D master &&
git checkout -b master origin/master &&
git checkout $branch
echo "..done"

if [ "$?" -gt 0 ]; then
  echo "git fetch of all commits failed (aborting)."
  echo "do you have diffs preventing a clean checkout?"
  exit 1
fi

echo "running tests against every commit in $branch"
echo "cmd => '$cmd'"

run=$("$dir/git-for-each" $branch "$cmd")

echo "$run"

failed=$(echo $run | grep "failed")

if [ ! -z "$failed" ]; then
  echo "failures detected in one or more branch commits, failing build."
  exit 1
fi
